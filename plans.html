<!-- CHUNK 1 START -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getFirestore, enableIndexedDbPersistence, collection, onSnapshot, doc, getDoc, updateDoc, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyArPe6RM7qbUC49XvbDZWvcpr_iGoIRzrA",
    authDomain: "trustvest-a1bd9.firebaseapp.com",
    projectId: "trustvest-a1bd9",
    storageBucket: "trustvest-a1bd9.appspot.com",
    messagingSenderId: "676220073092",
    appId: "1:676220073092:web:b358f8821ac33da9babed1"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  // Enable Offline Persistence
  enableIndexedDbPersistence(db).catch((err) => {
    console.error("Offline Persistence Failed", err);
  });

  let currentUserData = null;

  // Authenticate & Listen to Realtime Plan Updates
  onAuthStateChanged(auth, async (user) => {
    if (user) {
      const userRef = doc(db, "users", user.uid);
      const userSnap = await getDoc(userRef);
      if (userSnap.exists()) {
        currentUserData = userSnap.data();
        listenToPlansRealtime();
        listenToRecentPurchases(user.uid);
        updateProgressBar(currentUserData.activePlan);
      } else {
        window.location.href = "login.html";
      }
    } else {
      window.location.href = "login.html";
    }
  });

  function listenToPlansRealtime() {
    const plansRef = collection(db, "plans");
    onSnapshot(plansRef, (snapshot) => {
      const plansContainer = document.getElementById("plansSection");
      plansContainer.innerHTML = "";
      const plans = [];
      snapshot.forEach(doc => {
        plans.push({ id: doc.id, ...doc.data() });
      });

      // Sort by price ascending
      plans.sort((a, b) => a.price - b.price);

      plans.forEach(plan => {
        const planCard = document.createElement("div");
        planCard.className = "plan-card";
        planCard.style.backgroundImage = `url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" font-size="50"><text y="50%">${plan.icon}</text></svg>')`;
        planCard.innerHTML = `
          <div class="plan-title">${plan.name}</div>
          <div class="plan-price">₦${plan.price.toLocaleString()}</div>
          <button class="purchase-btn" data-plan-id="${plan.id}" data-plan-name="${plan.name}" data-plan-price="${plan.price}">Purchase</button>
        `;
        plansContainer.appendChild(planCard);
      });

      attachPurchaseEvent();
    });
  }

  function attachPurchaseEvent() {
    document.querySelectorAll('.purchase-btn').forEach(button => {
      button.addEventListener('click', () => {
        const planId = button.getAttribute('data-plan-id');
        const planName = button.getAttribute('data-plan-name');
        const planPrice = parseInt(button.getAttribute('data-plan-price'));
        confirmPurchase(planId, planName, planPrice);
      });
    });
  }
</script>
<!-- CHUNK 1 END -->
<!-- CHUNK 2 START -->
<script type="module">
  async function confirmPurchase(planId, planName, planPrice) {
    const overlay = document.createElement('div');
    overlay.style.cssText = `
      position: fixed; top:0; left:0; width:100%; height:100%;
      background: rgba(0,0,0,0.7);
      display: flex; justify-content: center; align-items: center;
      z-index: 10000;
    `;
    overlay.innerHTML = `
      <div style="background:#fff; color:#000; padding:20px; border-radius:10px; text-align:center;">
        <p>Confirm Purchase of <b>${planName}</b> for ₦${planPrice.toLocaleString()}?</p>
        <button id="confirmYes" style="margin:10px;">Yes</button>
        <button id="confirmNo" style="margin:10px;">No</button>
      </div>
    `;
    document.body.appendChild(overlay);

    document.getElementById('confirmNo').onclick = () => overlay.remove();

    document.getElementById('confirmYes').onclick = async () => {
      overlay.innerHTML = `<p style="color:#fff;">Processing...</p>`;
      const user = auth.currentUser;
      const userRef = doc(db, "users", user.uid);
      const userDoc = await getDoc(userRef);

      if (userDoc.exists()) {
        let balance = userDoc.data().balance || 0;
        if (balance >= planPrice) {
          await updateDoc(userRef, {
            balance: balance - planPrice,
            activePlan: planName
          });
          await addDoc(collection(db, "users", user.uid, "purchasedPlans"), {
            planId: planId,
            planName: planName,
            purchasedAt: serverTimestamp()
          });
          showToast("Purchase Successful!", "success");
          overlay.remove();
          updateProgressBar(planName);
          loadRecentPurchases(user.uid);
        } else {
          showToast("Insufficient Balance! Redirecting...", "error");
          overlay.remove();
          setTimeout(() => window.location.href = `deposit.html?amount=${planPrice}`, 1000);
        }
      }
    };
  }

  function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.innerText = message;
    toast.style.cssText = `
      position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%);
      background: ${type === 'success' ? '#00bfa6' : type === 'error' ? '#ff4c4c' : '#333'};
      color: #fff; padding: 10px 20px; border-radius: 25px;
      z-index: 9999; font-weight: bold;
      animation: fadeToast 3s forwards;
    `;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
  }

  function updateProgressBar(activePlanName) {
    const plans = ["TrustLite", "TrustPremium", "TrustBoosted", "TrustElite", "TrustLegend"];
    const index = plans.indexOf(activePlanName);
    const percentage = ((index + 1) / plans.length) * 100;
    document.getElementById("progressFill").style.width = `${percentage}%`;
  }

  function listenToRecentPurchases(userId) {
    const purchasesRef = collection(db, "users", userId, "purchasedPlans");
    onSnapshot(purchasesRef, (snapshot) => {
      const recentList = document.getElementById("recentPurchasesList");
      recentList.innerHTML = "";
      if (snapshot.empty) {
        recentList.innerHTML = `<div class="recent-item">No purchases yet.</div>`;
      } else {
        snapshot.forEach(doc => {
          const data = doc.data();
          const item = document.createElement("div");
          item.className = "recent-item";
          item.innerText = `${data.planName} - ${data.purchasedAt?.toDate().toLocaleDateString()}`;
          recentList.appendChild(item);
        });
      }
    });
  }
</script>
<style>
  @keyframes fadeToast {
    0% { opacity: 1; bottom: 80px; }
    80% { opacity: 1; }
    100% { opacity: 0; bottom: 100px; }
  }
</style>
<!-- CHUNK 2 END -->
<!-- CHUNK 3 START -->
<!-- Spinner Overlay -->
<div id="spinnerOverlay" style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);display:none;justify-content:center;align-items:center;z-index:9999;">
  <div style="border:5px solid #f3f3f3;border-top:5px solid #00bfa6;border-radius:50%;width:50px;height:50px;animation:spin 1s linear infinite;"></div>
</div>

<script>
  function toggleSpinner(show) {
    document.getElementById("spinnerOverlay").style.display = show ? 'flex' : 'none';
  }

  // Navigation Item Click Handler
  document.querySelectorAll('.nav-item').forEach(nav => {
    nav.addEventListener('click', () => {
      const page = nav.getAttribute('data-page');
      window.location.href = page;
    });
  });
</script>

<style>
  @keyframes spin {
    0% { transform: rotate(0deg);}
    100% { transform: rotate(360deg);}
  }
</style>

<!-- Tawk.to AI Chat Integration -->
<script type="text/javascript">
  var Tawk_API=Tawk_API||{}, Tawk_LoadStart=new Date();
  (function(){
    var s1=document.createElement("script"),s0=document.getElementsByTagName("script")[0];
    s1.async=true;
    s1.src='https://embed.tawk.to/688fdc6c88d9b3192aa8420e/1j1ova251';
    s1.charset='UTF-8';
    s1.setAttribute('crossorigin','*');
    s0.parentNode.insertBefore(s1,s0);
  })();
  Tawk_API.onLoad = function() {
    const tawkBubble = document.querySelector('iframe[title="chat widget"]');
    if (tawkBubble) {
      tawkBubble.style.bottom = '70px'; 
      tawkBubble.style.right = '20px';
    }
  };
</script>

<footer style="text-align:center; color:#555; font-size:12px; margin-top:20px; margin-bottom:80px;">
  &copy; 2025 TrustVest. All Rights Reserved.
</footer>
</body>
</html>
<!-- CHUNK 3 END -->
